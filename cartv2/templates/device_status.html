{% extends 'base.html' %}
{% block title %}Device Status - Smart Shopping Cart{% endblock %}
{% block content %}
<div class="container-fluid px-4 mx-auto overflow-hidden" style="max-width: 1800px;">
    <div class="content-wrapper">
        <!-- Notification Container -->
        <div id="notification-container"></div>
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary fw-bold"><i class="fas fa-server me-2"></i>Device Status Management</h2>
                <div>
                    <button id="addNewDevice" class="btn btn-success me-2">
                        <i class="fas fa-plus-circle me-1"></i> Add New Device
                    </button>
                    <button id="refreshData" class="btn btn-outline-primary">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                    <button id="showDebug" class="btn btn-outline-warning ms-2">
                        <i class="fas fa-bug me-1"></i> Debug
                    </button>
                    <div class="form-check form-switch d-inline-block ms-3">
                        <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                        <label class="form-check-label text-muted" for="autoRefreshToggle">Auto-refresh</label>
                    </div>
                    <small class="text-muted ms-2">Last updated: <span id="lastUpdated"></span></small>
                </div>
            </div>
            
            {# Debug section - Hidden by default #}
            <div id="debugSection" class="card shadow-sm border-0 rounded-3 mb-4" style="display: none;">
                <div class="card-header bg-warning py-3">
                    <h5 class="mb-0 fw-bold text-dark">Debug Information</h5>
                </div>
                <div class="card-body">
                    <h6>Device IDs:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Device ID</th>
                                    <th>Type</th>
                                    <th>Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices %}
                                <tr>
                                    <td><code>{{ device.device_id }}</code></td>
                                    <td><code>{{ device.device_id|stringformat:"r" }}</code></td>
                                    <td>{{ device.device_name }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <button id="toggleDebug" class="btn btn-sm btn-outline-secondary mt-2">Hide Debug Info</button>
                </div>
            </div>
            
            <div class="card shadow-sm border-0 rounded-3 mb-4">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 fw-bold text-primary">Connected Devices</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Device ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Usage Status</th>
                                    <th>App Status</th>
                                    <th>Last Connected</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deviceTableBody">
                                {% for device in devices %}
                                <tr data-device-id="{{ device.device_id|default:'' }}">
                                    <td><span class="fw-semibold">{{ device.device_id }}</span></td>
                                    <td>{{ device.device_name }}</td>
                                    <td><span class="badge bg-info text-white">{{ device.device_type }}</span></td>
                                    <td>{{ device.ip_address }}</td>
                                    <td>
                                        <span class="status-indicator {% if device.is_active %}active{% else %}inactive{% endif %}">
                                            <i class="fas fa-circle me-1"></i>
                                            {{ device.is_active|yesno:"Online,Offline" }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-indicator {% if device.devicestatus.status == 'in_use' %}in-use{% else %}available{% endif %}">
                                            <i class="fas fa-circle me-1"></i>
                                            {{ device.devicestatus.status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-indicator {% if device.app_running %}running{% else %}stopped{% endif %}">
                                            <i class="fas fa-circle me-1"></i>
                                            {{ device.app_running|yesno:"Running,Stopped" }}
                                        </span>
                                    </td>
                                    <td>{{ device.last_connected|date:"Y-m-d H:i:s" }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary toggle-device" 
                                                    data-device-id="{{ device.device_id }}"
                                                    data-current-status="{{ device.is_active|yesno:'true,false' }}"
                                                    data-bs-toggle="tooltip"
                                                    title="{{ device.is_active|yesno:'Turn Off Device,Turn On Device' }}">
                                                <i class="fas fa-power-off"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info toggle-app" 
                                                    data-device-id="{{ device.device_id }}"
                                                    data-current-status="{{ device.app_running|yesno:'true,false' }}"
                                                    data-bs-toggle="tooltip"
                                                    title="{{ device.app_running|yesno:'Stop App,Start App' }}">
                                                <i class="fas fa-play-circle"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-device"
                                                    data-device-id="{{ device.device_id }}"
                                                    data-device-name="{{ device.device_name }}"
                                                    data-bs-toggle="tooltip"
                                                    title="Delete Device">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-muted">
                                        <i class="fas fa-robot fa-3x mb-3"></i>
                                        <p>No devices connected</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals with improved design -->
<!-- Modal xác nhận xóa đã được kết hợp với modal nhập mật khẩu -->

<div class="modal fade" id="passwordVerificationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-lock me-2"></i>Confirm device deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Are you sure you want to erase the device "<span id="deviceNameInPasswordModal" class="fw-bold"></span>"?</p>
                <div class="form-group">
                    <label for="verificationPassword">Enter the administrator password to confirm:</label>
                    <input type="password" class="form-control" id="verificationPassword" autocomplete="off">
                </div>
                <div id="passwordError" class="alert alert-danger d-none mt-2">
                    Invalid password! Please try again.
                </div>
            </div>
                          <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="verifyPassword">Delete Device</button>
            </div>
        </div>
    </div>
</div>



<!-- Add error modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-warning text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-circle me-2"></i>Cart Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage" class="text-center mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add New Device</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm">
                    <div class="mb-3">
                        <label for="newDeviceId" class="form-label">Device ID</label>
                        <input type="text" class="form-control" id="newDeviceId" placeholder="raspi_cart_001" required>
                        <div class="form-text">Example: raspi_cart_001, scanner_checkout_002, display_003</div>
                    </div>
                    <div class="mb-3">
                        <label for="newDeviceName" class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="newDeviceName" placeholder="Smart Cart Display 1" required>
                        <div class="form-text">Example: Smart Cart Display 1, Scanner Checkout 2</div>
                    </div>
                    <div class="mb-3">
                        <label for="newDeviceType" class="form-label">Device Type</label>
                        <input type="text" class="form-control" id="newDeviceType" placeholder="raspberry_pi" list="deviceTypeList" required>
                        <datalist id="deviceTypeList">
                            <option value="raspberry_pi">Raspberry Pi</option>
                            <option value="cart">Cart</option>
                            <option value="scanner">Scanner</option>
                            <option value="display">Display</option>
                            <option value="checkout">Checkout</option>
                        </datalist>
                        <div class="form-text">Example: raspberry_pi, cart, scanner, display, checkout</div>
                    </div>
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Example:</strong><br>
                                DEVICE_ID = "raspi_cart_001"<br>
                                DEVICE_NAME = "Smart Cart Display 1"<br>
                                DEVICE_TYPE = "raspberry_pi"
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" id="fillExampleData">Enter Example</button>
                        </div>
                    </div>
                    <div id="deviceAddError" class="alert alert-danger d-none">
                        Error message will appear here
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitNewDevice">Add Device</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom Toast Notification System */
#notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    width: 350px;
}

.custom-toast {
    background-color: #fff;
    color: #333;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: flex-start;
    overflow: hidden;
    animation: slideIn 0.3s ease forwards;
    max-width: 100%;
    position: relative;
    border-left: 5px solid #007bff;
}

.custom-toast.success {
    border-left-color: #28a745;
}

.custom-toast.error {
    border-left-color: #dc3545;
}

.custom-toast.warning {
    border-left-color: #ffc107;
}

.custom-toast.info {
    border-left-color: #17a2b8;
}

.custom-toast .toast-icon {
    margin-right: 15px;
    font-size: 24px;
}

.custom-toast .toast-icon.success {
    color: #28a745;
}

.custom-toast .toast-icon.error {
    color: #dc3545;
}

.custom-toast .toast-icon.warning {
    color: #ffc107;
}

.custom-toast .toast-icon.info {
    color: #17a2b8;
}

.custom-toast .toast-content {
    flex: 1;
}

.custom-toast .toast-title {
    font-weight: 600;
    margin-bottom: 5px;
}

.custom-toast .toast-message {
    font-size: 0.9rem;
    color: #555;
}

.custom-toast .toast-close {
    position: absolute;
    top: 10px;
    right: 10px;
    color: #aaa;
    cursor: pointer;
    font-size: 16px;
    transition: color 0.2s;
}

.custom-toast .toast-close:hover {
    color: #333;
}

.custom-toast .toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background-color: rgba(0, 0, 0, 0.1);
    width: 100%;
}

.custom-toast .toast-progress-bar {
    height: 100%;
    background-color: #007bff;
    width: 100%;
    animation: progress 5s linear forwards;
}

.custom-toast.success .toast-progress-bar {
    background-color: #28a745;
}

.custom-toast.error .toast-progress-bar {
    background-color: #dc3545;
}

.custom-toast.warning .toast-progress-bar {
    background-color: #ffc107;
}

.custom-toast.info .toast-progress-bar {
    background-color: #17a2b8;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

@keyframes progress {
    from {
        width: 100%;
    }
    to {
        width: 0%;
    }
}

.status-indicator {
    padding: 0.25rem 0.75rem;
    border-radius: 50rem;
    font-size: 0.875rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    transition: all 0.3s ease-in-out;
}

.status-indicator.active {
    background-color: rgba(25, 135, 84, 0.1);
    color: #198754;
}

.status-indicator.inactive {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.status-indicator.running {
    background-color: rgba(25, 135, 84, 0.1);
    color: #198754;
}

.status-indicator.stopped {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.status-indicator.in-use {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.status-indicator.available {
    background-color: rgba(25, 135, 84, 0.1);
    color: #198754;
}

.status-indicator i {
    font-size: 0.5rem;
    transition: all 0.3s ease-in-out;
}

.status-indicator.active i { color: #28a745; }
.status-indicator.inactive i { color: #dc3545; }
.status-indicator.in-use i { color: #ffc107; }
.status-indicator.available i { color: #17a2b8; }
.status-indicator.running i { color: #28a745; }
.status-indicator.stopped i { color: #dc3545; }

.btn-group .btn {
    margin: 0 2px;
}

.card {
    transition: all 0.3s ease;
}

.table td, .table th {
    padding: 1rem;
}

/* Animation for newly updated rows */
@keyframes highlight {
    0% { background-color: rgba(13, 110, 253, 0.15); }
    100% { background-color: transparent; }
}

.highlight-update {
    animation: highlight 2s ease-out;
}

/* Fade-in animation for table rows */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.table tr {
    animation: fadeIn 0.3s ease-in;
}

/* Auto-refresh toggle styling */
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* Loading spinner styles */
.loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    display: none;
}

.table-responsive.loading .loading-spinner {
    display: block;
}

.table-responsive.loading .table {
    opacity: 0.6;
}

@media (min-width: 1400px) {
    .container-fluid {
        padding-left: 2rem !important;
        padding-right: 2rem !important;
    }
}

@media (max-width: 1399px) {
    .container-fluid {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }
}

/* Existing styles */
body {
    overflow-x: hidden;
}

.content-wrapper {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
}

.table-responsive {
    margin: 0;
    padding: 0;
    border: none;
    overflow-x: auto;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
}

.table-responsive::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
}

.table {
    width: 100%;
    min-width: 800px; 
}

/* Thêm styles mới cho table */
.table th {
    white-space: nowrap;
    padding: 1rem 0.75rem;
}

.table td {
    white-space: nowrap;
    padding: 0.75rem;
    vertical-align: middle;
}

.table td span {
    display: inline-block;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.status-indicator {
    min-width: 90px;
    justify-content: center;
}

/* Điều chỉnh độ rộng tối thiểu cho bảng */
.table {
    width: 100%;
    min-width: 1000px; /* Tăng min-width để đảm bảo không bị xuống dòng */
}

/* Đảm bảo các cột có độ rộng phù hợp */
.table th:nth-child(1), /* Device ID */
.table td:nth-child(1) {
    min-width: 100px;
}

.table th:nth-child(2), /* Name */
.table td:nth-child(2) {
    min-width: 150px;
}

.table th:nth-child(7), /* Last Connected */
.table td:nth-child(7) {
    min-width: 160px;
}

.table th:nth-child(8), /* Actions */
.table td:nth-child(8) {
    min-width: 140px;
}

/* Add these styles */
.check-shopping {
    margin-left: 4px;
}

#shoppingMonitorModal .table {
    margin-bottom: 0;
}

#shoppingMonitorModal .modal-body {
    padding: 1.5rem;
}

#refreshMonitor {
    padding: 0.25rem 0.5rem;
}

#refreshMonitor i {
    margin-right: 0.25rem;
}

.modal-lg {
    max-width: 800px;
}

#monitorCustomerName {
    font-weight: 600;
}

.modal-header h6 {
    margin: 0;
    font-size: 0.9rem;
}

/* Update table styles for more compact layout */
.table {
    width: 100%;
    min-width: auto; /* Remove fixed min-width */
    table-layout: fixed; /* Add fixed table layout */
}

/* Adjust column widths */
.table th,
.table td {
    padding: 0.75rem 0.5rem; /* Reduce padding */
    font-size: 0.9rem; /* Slightly smaller font */
}

/* Set specific widths for each column */
.table th:nth-child(1), /* Device ID */
.table td:nth-child(1) {
    width: 8%;
}

.table th:nth-child(2), /* Name */
.table td:nth-child(2) {
    width: 12%;
}

.table th:nth-child(3), /* Type */
.table td:nth-child(3) {
    width: 10%;
}

.table th:nth-child(4), /* IP Address */
.table td:nth-child(4) {
    width: 12%;
}

.table th:nth-child(5), /* Status */
.table td:nth-child(5) {
    width: 10%;
}

.table th:nth-child(6), /* Usage Status */
.table td:nth-child(6) {
    width: 10%;
}

.table th:nth-child(7), /* App Status */
.table td:nth-child(7) {
    width: 10%;
}

.table th:nth-child(8), /* Last Connected */
.table td:nth-child(8) {
    width: 15%;
}

.table th:nth-child(9), /* Actions */
.table td:nth-child(9) {
    width: 13%;
}

/* Adjust status indicators to be more compact */
.status-indicator {
    padding: 0.25rem 0.5rem;
    min-width: 80px;
    font-size: 0.8rem;
}

/* Make buttons in action column more compact */
.btn-group .btn {
    padding: 0.25rem 0.5rem;
    margin: 0 1px;
}

/* Update table-responsive styles */
.table-responsive {
    overflow-x: visible; /* Change from auto to visible */
    max-width: 100%;
    margin: 0;
    padding: 0;
}

/* Add container max-width */
.container-fluid {
    max-width: 1600px;
    margin: 0 auto;
}

/* Make sure content doesn't overflow */
.content-wrapper {
    overflow-x: hidden;
    padding: 0 1rem;
}

/* Adjust card body padding */
.card-body {
    padding: 1rem;
}

/* Add styles for shopping monitor table */
#shoppingMonitorModal .table th:nth-child(2), /* Quantity column */
#shoppingMonitorModal .table td:nth-child(2) {
    text-align: center;
}

#shoppingMonitorModal .table th:nth-child(3), /* Price column */
#shoppingMonitorModal .table td:nth-child(3),
#shoppingMonitorModal .table th:nth-child(4), /* Total column */
#shoppingMonitorModal .table td:nth-child(4) {
    text-align: right;
}

/* Add fade effect for table rows */
.table tbody tr {
    transition: opacity 0.3s ease-in-out;
}

.table tbody tr.updating {
    opacity: 0.7;
}
</style>

<script>
// Custom notification system
const notifications = {
    show: function(type, title, message, duration = 5000) {
        const container = document.getElementById('notification-container');
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `custom-toast ${type}`;
        
        // Set icon based on type
        let iconClass;
        switch(type) {
            case 'success':
                iconClass = 'fas fa-check-circle';
                break;
            case 'error':
                iconClass = 'fas fa-exclamation-circle';
                break;
            case 'warning':
                iconClass = 'fas fa-exclamation-triangle';
                break;
            case 'info':
            default:
                iconClass = 'fas fa-info-circle';
                break;
        }
        
        // Create toast content
        toast.innerHTML = `
            <div class="toast-icon ${type}">
                <i class="${iconClass}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <div class="toast-close">
                <i class="fas fa-times"></i>
            </div>
            <div class="toast-progress">
                <div class="toast-progress-bar"></div>
            </div>
        `;
        
        // Add to container
        container.appendChild(toast);
        
        // Setup close button
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', () => {
            this.dismiss(toast);
        });
        
        // Auto dismiss after duration
        setTimeout(() => {
            this.dismiss(toast);
        }, duration);
        
        return toast;
    },
    
    dismiss: function(toast) {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        
        // Remove from DOM after animation completes
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    },
    
    success: function(title, message, duration) {
        return this.show('success', title, message, duration);
    },
    
    error: function(title, message, duration) {
        return this.show('error', title, message, duration);
    },
    
    warning: function(title, message, duration) {
        return this.show('warning', title, message, duration);
    },
    
    info: function(title, message, duration) {
        return this.show('info', title, message, duration);
    }
};

// Auto-refresh configuration
let autoRefreshEnabled = true;
let refreshInterval = 5000; // 5 seconds
let refreshTimer = null;

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Show welcome notification
    setTimeout(() => {
        notifications.info("Device Management", "Welcome to the Device Status Management panel");
    }, 500);
    // Debug section toggle buttons
    const showDebugBtn = document.getElementById('showDebug');
    const toggleDebugBtn = document.getElementById('toggleDebug');
    
    if (showDebugBtn) {
        showDebugBtn.addEventListener('click', function() {
            const debugSection = document.getElementById('debugSection');
            if (debugSection) {
                debugSection.style.display = 'block';
                this.style.display = 'none';
            }
        });
    }
    
    if (toggleDebugBtn) {
        toggleDebugBtn.addEventListener('click', function() {
            const debugSection = document.getElementById('debugSection');
            const showDebugBtn = document.getElementById('showDebug');
            if (debugSection) {
                debugSection.style.display = 'none';
                if (showDebugBtn) {
                    showDebugBtn.style.display = 'inline-block';
                }
            }
        });
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Update timestamp
    updateTimestamp();

    // Setup auto-refresh toggle
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    autoRefreshToggle.addEventListener('change', function() {
        autoRefreshEnabled = this.checked;
        if (autoRefreshEnabled) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });

    // Start auto-refresh by default
    startAutoRefresh();

    // Refresh button handler - FIXED to properly reload data
    document.getElementById('refreshData').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        // Option 1: Full page reload
        window.location.reload();
        
        // Option 2: Just refresh data without page reload
        // fetchDeviceStatus();
        // setTimeout(() => {
        //     icon.classList.remove('fa-spin');
        // }, 1000);
    });

    // Toggle device status
    document.querySelectorAll('.toggle-device').forEach(button => {
        button.addEventListener('click', function() {
            const deviceId = this.dataset.deviceId;
            const currentStatus = this.dataset.currentStatus === 'true';
            updateDeviceStatus(deviceId, !currentStatus, 'is_active');
        });
    });

    // Toggle app status
    document.querySelectorAll('.toggle-app').forEach(button => {
        button.addEventListener('click', function() {
            const deviceId = this.dataset.deviceId;
            const currentStatus = this.dataset.currentStatus === 'true';
            updateDeviceStatus(deviceId, !currentStatus, 'app_running');
        });
    });

    // Biến toàn cục để lưu thông tin thiết bị cần xóa
    let pendingDeleteDeviceId = null;
    let pendingDeleteDeviceName = null;
    let passwordVerified = false;

    // Delete device handler
    document.querySelectorAll('.delete-device').forEach(button => {
        button.addEventListener('click', function(e) {
            // Ngăn hành vi mặc định
            e.preventDefault();
            
            // Lấy row chứa thiết bị
            const row = this.closest('tr');
            
            // Ưu tiên lấy device_id từ row trước
            const deviceIdFromRow = row.getAttribute('data-device-id');
            
            // Sau đó thử lấy từ span chứa ID thiết bị
            const deviceIdSpan = row.querySelector('td:first-child span.fw-semibold');
            const deviceIdFromSpan = deviceIdSpan ? deviceIdSpan.textContent.trim() : '';
            
            // Cuối cùng, thử lấy từ button
            const deviceIdFromButton = this.getAttribute('data-device-id');
            
            // Thử lấy tên thiết bị từ row
            const deviceNameCell = row.querySelector('td:nth-child(2)');
            const deviceNameFromCell = deviceNameCell ? deviceNameCell.textContent.trim() : '';
            
            // Lấy tên thiết bị từ thuộc tính của button
            const deviceNameFromButton = this.getAttribute('data-device-name');
            
            // Chọn nguồn ID và tên thiết bị tốt nhất
            const deviceId = deviceIdFromSpan || deviceIdFromRow || deviceIdFromButton;
            const deviceName = deviceNameFromCell || deviceNameFromButton;
            
            // Log tất cả thông tin để debug
            console.log("Thông tin chi tiết thiết bị:", {
                "ID từ row": deviceIdFromRow,
                "ID từ span": deviceIdFromSpan,
                "ID từ button": deviceIdFromButton,
                "ID đã chọn": deviceId,
                "Tên từ cell": deviceNameFromCell,
                "Tên từ button": deviceNameFromButton,
                "Tên đã chọn": deviceName,
                "HTML của row": row.outerHTML
            });
            
            // Kiểm tra device_id
            if (!deviceId || deviceId === 'string' || deviceId === 'undefined' || deviceId === 'None') {
                console.error("Invalid device ID:", deviceId);
                notifications.error("Invalid Device ID", "The device ID is invalid. Please refresh the page and try again.");
                return;
            }
            
            // Sử dụng ID thiết bị đã xác định
            const finalDeviceId = deviceId;
            
            // Lưu thông tin thiết bị cần xóa vào biến toàn cục
            pendingDeleteDeviceId = finalDeviceId;
            pendingDeleteDeviceName = deviceName;
            
            console.log("Đã lưu thông tin thiết bị cần xóa:", {
                "ID": pendingDeleteDeviceId,
                "Tên": pendingDeleteDeviceName
            });
            
            // Hiển thị tên thiết bị trong modal xác nhận mật khẩu
            document.getElementById('deviceNameInPasswordModal').textContent = deviceName;
            
            // Mở modal xác nhận mật khẩu
            $('#passwordVerificationModal').modal('show');
        });
    });

    // Handle verification button click
document.getElementById('verifyPassword').addEventListener('click', function() {
    console.log("Delete device button clicked");
    const password = document.getElementById('verificationPassword').value;
    console.log("Password check: Input length =", password.length, "characters");
    
    const correctPassword = '{{ settings.DEVICE_MANAGEMENT_PASSWORD }}';
    console.log("Password to check length:", correctPassword.length, "characters");
    
    // Compare passwords
    const isPasswordCorrect = (password === correctPassword);
    console.log("Password check result:", isPasswordCorrect ? "Correct" : "Incorrect");
    
    if (isPasswordCorrect) {
        console.log("Password verification successful");
        passwordVerified = true;
        notifications.success("Authentication Successful", "Password verified successfully.");
        
                 // Kiểm tra lại ID thiết bị trước khi xóa
        if (!pendingDeleteDeviceId || pendingDeleteDeviceId === 'string' || 
            pendingDeleteDeviceId === 'undefined' || pendingDeleteDeviceId === 'None') {
            console.error("Invalid device ID:", pendingDeleteDeviceId);
            $('#passwordVerificationModal').modal('hide');
            notifications.error("Invalid Device ID", "The device ID is invalid. Please refresh the page and try again.");
            return;
        }
        
        // Ghi log thông tin thiết bị cần xóa
        console.log("Thông tin thiết bị cần xóa:", {
            ID: pendingDeleteDeviceId,
            Tên: pendingDeleteDeviceName
        });
        
        // Đóng modal xác nhận mật khẩu
        $('#passwordVerificationModal').modal('hide');
        
        // Chờ một chút để modal đóng hoàn toàn trước khi gọi hàm xóa
        setTimeout(function() {
            console.log("Gọi hàm xóa thiết bị sau khi modal đóng");
            deleteDevice();
        }, 500);
    } else {
        console.log("Password verification failed");
        document.getElementById('passwordError').classList.remove('d-none');
        document.getElementById('passwordError').textContent = "Invalid password. Please try again.";
    }
    
    // Prevent default form submission
    return false;
});

    // Xử lý sự kiện nhấn Enter trong ô mật khẩu
    document.getElementById('verificationPassword').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('verifyPassword').click();
        }
    });

    // Function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Hàm thực hiện xóa thiết bị
function deleteDevice() {
    console.log("Bắt đầu hàm deleteDevice");
    
    if (!pendingDeleteDeviceId) {
        console.error("No device ID to delete");
        notifications.error("Error", "Device information not found");
        return;
    }
    
    if (!passwordVerified) {
        console.error("Password not verified");
        notifications.error("Authentication Required", "Please verify your password first");
        $('#passwordVerificationModal').modal('show');
        return;
    }
    
    console.log("Deleting device:", {
        "ID": pendingDeleteDeviceId,
        "Name": pendingDeleteDeviceName
    });
    
    // Sử dụng Fetch API trực tiếp với DELETE method và CSRF token
    console.log("Gửi DELETE request trực tiếp cho thiết bị ID:", pendingDeleteDeviceId);
    
    const csrfToken = getCookie('csrftoken');
    console.log("CSRF Token được tìm thấy:", csrfToken ? "Có" : "Không");
    
    // URL xóa thiết bị
    const deleteUrl = `/api/devices/${encodeURIComponent(pendingDeleteDeviceId)}/delete/`;
    
    // Show processing notification
    notifications.info("Processing", "Deleting device, please wait...");
    
    // Create processing overlay
    const processingOverlay = document.createElement('div');
    processingOverlay.style.position = 'fixed';
    processingOverlay.style.top = '0';
    processingOverlay.style.left = '0';
    processingOverlay.style.width = '100%';
    processingOverlay.style.height = '100%';
    processingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
    processingOverlay.style.zIndex = '9998';
    processingOverlay.style.display = 'flex';
    processingOverlay.style.justifyContent = 'center';
    processingOverlay.style.alignItems = 'center';
    
    const spinner = document.createElement('div');
    spinner.className = 'spinner-border text-light';
    spinner.style.width = '3rem';
    spinner.style.height = '3rem';
    spinner.setAttribute('role', 'status');
    
    processingOverlay.appendChild(spinner);
    document.body.appendChild(processingOverlay);
    
    // Gửi request trực tiếp sử dụng fetch với method DELETE
    fetch(deleteUrl, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log("Phản hồi từ server:", response.status, response.statusText);
        
                if (response.ok) {
                // Hiển thị thông báo thành công
                notifications.success("Device Deleted", `Device "${pendingDeleteDeviceName}" has been successfully deleted.`);
                
                // Làm mới trang sau 1 giây để người dùng nhìn thấy thông báo
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
            // Xử lý lỗi
            return response.text().then(text => {
                try {
                    const errorData = JSON.parse(text);
                    throw new Error(errorData.error || `Lỗi khi xóa thiết bị: ${response.statusText}`);
                } catch (e) {
                    throw new Error(`Lỗi khi xóa thiết bị: ${response.statusText}`);
                }
            });
        }
    })
            .catch(error => {
            console.error("Error sending DELETE request:", error);
            notifications.error("Deletion Failed", error.message || "Unable to delete the device. Please try again later.");
        })
    .finally(() => {
        // Remove processing overlay
        document.body.removeChild(processingOverlay);
    });
}

// Reset verification state when modal is closed
$('#passwordVerificationModal').on('hidden.bs.modal', function () {
    document.getElementById('verificationPassword').value = '';
    document.getElementById('passwordError').classList.add('d-none');
    
    // Chỉ reset trạng thái nếu chưa xác minh thành công
    if (!passwordVerified) {
        pendingDeleteDeviceId = null;
        pendingDeleteDeviceName = null;
    }
});

    // Add new device button handler
    document.getElementById('addNewDevice').addEventListener('click', function() {
        // Hiển thị modal thêm thiết bị mới
        $('#addDeviceModal').modal('show');
    });
    
    // Fill example data handler
    document.getElementById('fillExampleData').addEventListener('click', function() {
        // Tạo ID thiết bị với thời gian để đảm bảo không trùng lặp
        const timestamp = new Date().getTime().toString().slice(-6);
        document.getElementById('newDeviceId').value = `raspi_cart_${timestamp}`;
        document.getElementById('newDeviceName').value = "Smart Cart Display 1";
        document.getElementById('newDeviceType').value = "raspberry_pi";
    });
    
    // Handle form submission for new device
    document.getElementById('submitNewDevice').addEventListener('click', function() {
        // Lấy giá trị từ form
        const deviceId = document.getElementById('newDeviceId').value.trim();
        const deviceName = document.getElementById('newDeviceName').value.trim();
        const deviceType = document.getElementById('newDeviceType').value.trim();
        const errorElement = document.getElementById('deviceAddError');
        
        // Validate input
        if (!deviceId || !deviceName || !deviceType) {
            errorElement.textContent = "Please fill in all device information";
            errorElement.classList.remove('d-none');
            return;
        }
        
        // Ẩn thông báo lỗi nếu có
        errorElement.classList.add('d-none');
        
        // Tạo thiết bị mới thông qua API
        const csrfToken = getCookie('csrftoken');
        
        // Thay đổi nút submit để hiển thị trạng thái đang xử lý
        const submitButton = document.getElementById('submitNewDevice');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        
        fetch('/api/devices/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                device_id: deviceId,
                device_name: deviceName,
                device_type: deviceType
            })
        })
        .then(response => {
            if (response.ok) {
                // Đóng modal
                $('#addDeviceModal').modal('hide');
                
                // Reset form
                document.getElementById('addDeviceForm').reset();
                
                // Hiển thị thông báo thành công
                notifications.success("Device Added", "New device has been successfully added!");
                
                // Làm mới trang sau 1 giây để hiển thị thiết bị mới
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                return response.json().then(data => {
                    throw new Error(data.detail || data.error || "Không thể thêm thiết bị mới");
                });
            }
        })
        .catch(error => {
            // Hiển thị lỗi trong form
            errorElement.textContent = "Lỗi: " + error.message;
            errorElement.classList.remove('d-none');
            
            // Khôi phục nút submit
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        });
    });
});

// Start auto-refresh timer
function startAutoRefresh() {
    console.log("Starting auto-refresh timer with interval:", refreshInterval, "ms"); // Debug logging
    
    // Clear existing timer if any
    if (refreshTimer !== null) {
        clearInterval(refreshTimer);
    }
    
    // Initial fetch
    fetchDeviceStatus();
    
    // Setup interval
    refreshTimer = setInterval(() => {
        if (autoRefreshEnabled) {
            console.log("Auto-refresh triggered"); // Debug logging
            fetchDeviceStatus();
        }
    }, refreshInterval);
}

// Stop auto-refresh timer
function stopAutoRefresh() {
    console.log("Stopping auto-refresh timer"); // Debug logging
    if (refreshTimer !== null) {
        clearInterval(refreshTimer);
        refreshTimer = null;
    }
}

// Update timestamp display
function updateTimestamp() {
    const now = new Date();
    document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
}

// Improved fetchDeviceStatus with more comprehensive data retrieval
function fetchDeviceStatus() {
    const tableContainer = document.querySelector('.table-responsive');
    tableContainer.classList.add('loading');
    
    // First try to use all-status endpoint which includes all device data in one request
    fetch('/api/devices/all-status/')
        .then(response => {
            if (!response.ok) {
                throw new Error('All-status endpoint failed');
            }
            return response.json();
        })
        .then(allDevices => {
            console.log("All devices status:", allDevices);
            
            // Debug log for date formats
            allDevices.forEach(device => {
                if (device.last_connected) {
                    console.log(`Device ${device.device_id} last_connected:`, device.last_connected, 
                                `(type: ${typeof device.last_connected})`);
                }
            });
            
            // Update each device UI
            allDevices.forEach(deviceData => {
                if (deviceData.device_id) {
                    updateDeviceUI(deviceData.device_id, deviceData);
                }
            });
            
            tableContainer.classList.remove('loading');
            updateTimestamp();
        })
        .catch(error => {
            console.error("Error fetching all devices:", error);
            
            // Fallback to individual device requests
            Promise.all(
                Array.from(document.querySelectorAll('tr[data-device-id]')).map(row => {
                    const deviceId = row.dataset.deviceId;
                    return fetch(`/api/devices/${deviceId}/status/`)
                        .then(response => response.json())
                        .then(data => {
                            console.log(`Device ${deviceId} status response:`, data);
                            
                            // Debug log for date format
                            if (data.last_connected || (data.device && data.device.last_connected)) {
                                const dateStr = data.last_connected || (data.device && data.device.last_connected);
                                console.log(`Device ${deviceId} last_connected:`, dateStr, 
                                           `(type: ${typeof dateStr})`);
                            }
                            
                            // Handle different response formats
                            if (data.success && data.device) {
                                updateDeviceUI(deviceId, data.device);
                            } else if (data.device_id) {
                                updateDeviceUI(deviceId, data);
                            } else {
                                updateDeviceUI(deviceId, data);
                            }
                            return true;
                        })
                        .catch(error => {
                            console.error(`Error fetching device ${deviceId}:`, error);
                            return false;
                        });
                })
            ).finally(() => {
                tableContainer.classList.remove('loading');
                updateTimestamp();
            });
        });
}

// Enhanced updateDeviceUI function with smoother animations
function updateDeviceUI(deviceId, data) {
    const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
    if (!row) return;
    
    console.log("Updating device UI with data:", data); // Debug logging
    
    // Add highlight effect to show updated row
    row.classList.add('highlight-update');
    setTimeout(() => {
        row.classList.remove('highlight-update');
    }, 2000);
    
    // Update Device Status
    if (data.hasOwnProperty('is_active')) {
        const statusCell = row.querySelector('td:nth-child(5) .status-indicator');
        statusCell.className = `status-indicator ${data.is_active ? 'active' : 'inactive'}`;
        statusCell.innerHTML = `<i class="fas fa-circle me-1"></i>${data.is_active ? 'Online' : 'Offline'}`;
        
        const toggleBtn = row.querySelector('.toggle-device');
        toggleBtn.dataset.currentStatus = String(data.is_active);
        toggleBtn.setAttribute('data-bs-original-title', data.is_active ? 'Turn Off Device' : 'Turn On Device');
        
        // Refresh tooltip
        const tooltip = bootstrap.Tooltip.getInstance(toggleBtn);
        if (tooltip) {
            tooltip.dispose();
            new bootstrap.Tooltip(toggleBtn);
        }
    }
    
    // Update Usage Status
    // Check for status in both data.devicestatus and directly in data
    let deviceStatus = null;
    if (data.hasOwnProperty('devicestatus') && data.devicestatus) {
        deviceStatus = data.devicestatus.status;
    } else if (data.hasOwnProperty('status')) {
        deviceStatus = data.status;
    }
    
    if (deviceStatus) {
        const usageCell = row.querySelector('td:nth-child(6) .status-indicator');
        const isInUse = deviceStatus === 'in_use';
        usageCell.className = `status-indicator ${isInUse ? 'in-use' : 'available'}`;
        usageCell.innerHTML = `<i class="fas fa-circle me-1"></i>${deviceStatus.charAt(0).toUpperCase() + deviceStatus.slice(1)}`;
    }
    
    // Update App Status
    if (data.hasOwnProperty('app_running')) {
        const appStatusCell = row.querySelector('td:nth-child(7) .status-indicator');
        appStatusCell.className = `status-indicator ${data.app_running ? 'running' : 'stopped'}`;
        appStatusCell.innerHTML = `<i class="fas fa-circle me-1"></i>${data.app_running ? 'Running' : 'Stopped'}`;
        
        const toggleBtn = row.querySelector('.toggle-app');
        toggleBtn.dataset.currentStatus = String(data.app_running);
        toggleBtn.setAttribute('data-bs-original-title', data.app_running ? 'Stop App' : 'Start App');
        
        // Refresh tooltip
        const tooltip = bootstrap.Tooltip.getInstance(toggleBtn);
        if (tooltip) {
            tooltip.dispose();
            new bootstrap.Tooltip(toggleBtn);
        }
    }
    
    // Update Last Connected
    if (data.hasOwnProperty('last_connected')) {
        const lastConnectedCell = row.querySelector('td:nth-child(8)');
        
        try {
            // Use our robust date parser
            const dateObj = parseDate(data.last_connected);
            
            if (dateObj) {
                lastConnectedCell.textContent = formatDateTime(dateObj);
            } else {
                // If parsing failed, show original string or N/A
                lastConnectedCell.textContent = typeof data.last_connected === 'string' ? 
                    data.last_connected : "N/A";
            }
        } catch (error) {
            console.error("Error handling last_connected:", error);
            lastConnectedCell.textContent = "N/A";
        }
    }
}

// Helper function to parse date strings in various formats
function parseDate(dateStr) {
    if (!dateStr) return null;
    
    // If it's already a Date object
    if (dateStr instanceof Date) {
        return isNaN(dateStr.getTime()) ? null : dateStr;
    }
    
    // Handle string formats
    if (typeof dateStr === 'string') {
        dateStr = dateStr.trim();
        
        // Try various date formats
        let dateObj;
        
        // Try common formats one by one
        const formats = [
            // Try ISO format: "2023-05-18T12:34:56.789Z"
            () => new Date(dateStr),
            
            // Try format: "2023-05-18 12:34:56"
            () => new Date(dateStr.replace(' ', 'T')),
            
            // Try format: "18/05/2023 12:34:56"
            () => {
                const parts = dateStr.split(/[\/\s:]/);
                if (parts.length >= 6) {
                    return new Date(
                        parseInt(parts[2]), // year
                        parseInt(parts[1]) - 1, // month (0-based)
                        parseInt(parts[0]), // day
                        parseInt(parts[3]), // hour
                        parseInt(parts[4]), // minute
                        parseInt(parts[5])  // second
                    );
                }
                return null;
            },
            
            // Try format: "May 18, 2023 12:34:56"
            () => new Date(dateStr)
        ];
        
        // Try each format until one works
        for (const formatFn of formats) {
            try {
                dateObj = formatFn();
                if (dateObj && !isNaN(dateObj.getTime())) {
                    return dateObj;
                }
            } catch (e) {
                // Continue to next format
            }
        }
    }
    
    // If all parsing attempts failed
    console.error("Failed to parse date:", dateStr);
    return null;
}

// Format date-time for display
function formatDateTime(date) {
    // Parse the date if it's a string
    if (typeof date === 'string') {
        date = parseDate(date);
    }
    
    // Check if date is valid
    if (!date || isNaN(date.getTime())) {
        console.error("Invalid date:", date);
        return "N/A"; // Return N/A instead of invalid date formatting
    }
    
    try {
        return date.getFullYear() + '-' + 
            String(date.getMonth() + 1).padStart(2, '0') + '-' +
            String(date.getDate()).padStart(2, '0') + ' ' +
            String(date.getHours()).padStart(2, '0') + ':' +
            String(date.getMinutes()).padStart(2, '0') + ':' +
            String(date.getSeconds()).padStart(2, '0');
    } catch (error) {
        console.error("Error formatting date:", error);
        return "N/A";
    }
}

// Existing functions for shopping monitor


// Format currency for display
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount);
}
</script>
{% endblock %} 

